---
title: "800-klamath-sacremento"
author: "Mac Campbell"
date: "4/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message=FALSE)
```

```{r}
library(tidyverse)
library(ggrepel)
library(ggpubr)
```

## Samples sequenced

 `Common Name`     Subspecies    Coordinates                Count      
  <chr>             <chr>         <chr>                      <int>    
1 Modoc Sucker      NA            Ash Creek: Johnson            10     
2 Modoc Sucker      NA            Turner Creek: Garden Gulch    10     
3 Sacremento Sucker lacuanserinus Cottonwood                     9     
4 Sacremento Sucker lacuanserinus Goose Lake: Dent               5    
5 Sacremento Sucker occidentalis  Ash Creek: Ash Valley         13    

q's: Are all Sacramento Suckes most-closely related to each other?  Thomas Creek in Goose Lake Basin is the third location of Modoc that exists and we don't have it. But, we can see if Cottonwood/Dent are more closely related to Ash (but expecting hybrids)

I expect the S. lacuanserinus + Modoc Sucker to be most closely related to each other. 

```{r}
b3b<-read_tsv("meta/b3b.tsv") 
mm<-read_csv("meta/additional-meta.csv") %>% select(`GVL Code`,Coordinates) %>% rename(`Sample ID` = `GVL Code`)
sacs<- b3b %>% filter(`Species Common Name` %in% c("Modoc Sucker","Sacremento Sucker")) %>% left_join(mm)
```

```{r}
sacs %>% filter(Counts > 5e4) %>% select(`Sample ID`, `Species Common Name`, Counts, Coordinates) 
```
```{r}
sacs %>% filter(Counts > 5e4) %>% select(`Sample ID`, `Species Common Name`, Counts, Coordinates) %>%
  group_by(`Species Common Name`, Coordinates) %>% summarize(Count=n())
``` 
```{r}
ggplot(sacs %>% filter(Counts > 5e4)) +
  geom_histogram(aes(x=Counts, fill=`Species Common Name`)) +
  xlim(0, 1.5e6)
```


## doIBs

```{r}
r1<-sacs %>% filter(Counts > 5e4)
write_tsv(r1 %>% select(NewPath), col_names = FALSE, file="bamlists/sacs33.bamlist")
```


```{sh, eval=FALSE}
srun -p med -t 2:00:00 --mem=32G --nodes=1 $HOME/angsd/angsd -P 36  \
-bam bamlists/sacs33.bamlist  -r 'lcl|RBS_Chr1' \
-ref /$HOME/genomes/xyrauchen/Xyrauchen_texanus.faa \
-minInd 17 -minMapQ 10 -minQ 20 -GL 2 -doGLF 2 \
-doMajorMinor 1 -doMaf 1 -SNP_pval 1e-3 \
-doIBS 1 -doCounts 1 -doCov 1 -makeMatrix 1 -minMaf 0.05 \
-out outputs/800/33-chrom01-ibs > outputs/800/33-chrom01-ibs.stdout 2> outputs/800/33-chrom01-ibs.stderr &

srun -p med -t 2:00:00 --mem=32G --nodes=1 $HOME/angsd/angsd -P 36  \
-bam bamlists/sacs33.bamlist \
-ref /$HOME/genomes/xyrauchen/Xyrauchen_texanus.faa \
-minInd 17 -minMapQ 10 -minQ 20 -GL 2 -doGLF 2 \
-doMajorMinor 1 -doMaf 1 -SNP_pval 1e-3 \
-doIBS 1 -doCounts 1 -doCov 1 -makeMatrix 1 -minMaf 0.05 \
-out outputs/800/33-ibs > outputs/800/33-ibs.stdout 2> outputs/800/33-ibs.stderr &

srun -p med -t 2:00:00 --mem=32G --nodes=1 $HOME/angsd/angsd -P 36  \
-bam bamlists/sacs33.bamlist \
-ref /$HOME/genomes/xyrauchen/Xyrauchen_texanus.faa \
-minInd 30 -minMapQ 10 -minQ 20 -GL 2 -doGLF 2 \
-doMajorMinor 1 -doMaf 1 -SNP_pval 1e-3 \
-doIBS 1 -doCounts 1 -doCov 1 -makeMatrix 1 -minMaf 0.05 \
-out outputs/800/33-ibs-90 > outputs/800/33-ibs.stdout 2> outputs/800/33-ibs.stderr &
```

6,601 snps on chrom01
191666 total 50% missing
```{r}
m <- as.matrix(read.table("outputs/800/33-ibs.covMat"))
meta<-r1
eig <- eigen(m)
var<-eig$values/sum(eig$values)
cumvar<-cumsum(eig$values)/sum(eig$values)

head(var)
head(cumvar)
covs<-eig$vectors[,1:3] %>% as_tibble() %>% bind_cols(meta)

text12<-covs %>% select(`Sample ID`, `Species Common Name`, Coordinates, V1, V2) %>%
  group_by(`Species Common Name`, Coordinates,) %>% summarize(Count=n(), x=mean(V1), y=mean(V2))

covs12<-ggplot(covs) +
  geom_point(aes(x=V1, y=V2, fill=`Species Common Name`), pch=21, alpha=0.75) +
  geom_text_repel(data=text12, aes(x=x, y=y, label=Coordinates), max.overlaps = Inf) +
  xlab(paste("PC1", " ", round((100*var[1]),2), "%", sep = "")) +
  ylab(paste("PC2", " ", round((100*var[2]),2), "%", sep = "")) +
  theme_bw() +
  theme(legend.position="")


text13<-covs %>% select(`Sample ID`, `Species Common Name`,Coordinates, V1, V3) %>%
 group_by(`Species Common Name`, Coordinates) %>% summarize(Count=n(), x=mean(V1), y=mean(V3))

covs13<-ggplot(covs) +
  geom_point(aes(x=V1, y=V3, fill=`Species Common Name`), pch=21, alpha=0.75) +
  geom_text_repel(data=text13, aes(x=x, y=y, label=Coordinates), max.overlaps = Inf) +
  xlab(paste("PC1", " ", round((100*var[1]),2), "%", sep = "")) +
  ylab(paste("PC3", " ", round((100*var[3]),2), "%", sep = "")) +
  theme_bw() 

ggarrange(covs12, covs13, widths = c(1,1.25))

ggsave("outputs/800/sac-33-pcs.jpeg", width=10, height=5)
```

## Outgroup + Call SNPs?

```{r}
myfish<-read.csv("meta/phylo119.csv")  %>% filter(Species.Common.Name %in% c("Klamath Largescale Sucker","Klamath Smallscale Sucker","Lost River Sucker","Shortnose Sucker")) %>%
  mutate(Coordinates="Klamath Basin") %>% select(Sample.ID, Species.Common.Name,Counts,Location,Coordinates, NewPath ) %>%
  rename(`Sample ID`=Sample.ID, `Species Common Name`=Species.Common.Name)

r2<-select(r1,`Sample ID`, `Species Common Name`, Counts, Location, Coordinates, NewPath) %>% 
  bind_rows(myfish) 


```